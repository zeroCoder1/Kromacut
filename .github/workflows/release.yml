name: Release Native App

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:

permissions:
    contents: write

jobs:
    release:
        strategy:
            matrix:
                include:
                    - platform: 'macos-latest'
                      args: '--target aarch64-apple-darwin'
                    - platform: 'macos-latest'
                      args: '--target x86_64-apple-darwin'

        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-apple-darwin,x86_64-apple-darwin

            - name: Install dependencies
              run: npm ci

            - name: Build and release
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: 'Kromacut ${{ github.ref_name }}'
                  releaseBody: |
                      ## What's New
                      
                      Download the DMG file below for a native Mac application with better performance than the web version.
                      
                      ### Installation
                      
                      1. **Download** the `.dmg` file for your Mac chip:
                         - **Apple Silicon (M1/M2/M3)**: `*_aarch64.dmg`
                         - **Intel**: `*_x86_64.dmg`
                      
                      2. **Open the DMG** and drag Kromacut to your Applications folder
                      
                      3. **Remove quarantine attribute** (required for unsigned apps):
                         ```bash
                         xattr -cr /Applications/Kromacut.app
                         ```
                         Or open Terminal and run:
                         ```bash
                         xattr -d com.apple.quarantine /Applications/Kromacut.app
                         ```
                      
                      4. **Launch** the app from Applications
                      
                      ### If You See "Damaged" Error
                      
                      If macOS says the app is "damaged," it's because the app isn't code-signed. Run this command in Terminal:
                      ```bash
                      xattr -cr /Applications/Kromacut.app
                      ```
                      Then try opening the app again. This removes the quarantine flag macOS adds to downloaded files.
                      
                      ### Features
                      - Native macOS performance with WebKit
                      - Better GPU acceleration for 3D rendering  
                      - Lower memory usage than web version
                      - Faster image processing
                  releaseDraft: false
                  prerelease: false
                  args: ${{ matrix.args }}
